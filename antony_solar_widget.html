<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Antony Solaire – Widget Photovoltaïque</title>
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      max-width: 900px;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    label {
      font-weight: 600;
    }
    select {
      padding: 0.25rem 0.5rem;
      font-size: 0.95rem;
    }
    #status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    canvas {
      max-width: 100%;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Antony – photovoltaïque (data ODRE)</h1>

  <div class="controls">
    <div>
      <label for="metric-select">Afficher :</label>
      <select id="metric-select">
        <option value="prod_1y_kwh">Production annuelle</option>
        <option value="pow_inst_kw">Puissance installée</option>
        <option value="total_inst">Nombre d'installations</option>
      </select>
    </div>

    <div>
      <label for="mode-select">Découpage :</label>
      <select id="mode-select">
        <option value="iris">Par quartier (empilé)</option>
        <option value="total">Total Antony</option>
      </select>
    </div>
  </div>

  <div id="status">Chargement des données…</div>

  <canvas id="solarChart" width="800" height="400"></canvas>

  <script>
    // -------------------------
    // Configuration / constants
    // -------------------------

    const ODRE_BASE = "https://odre.opendatasoft.com/api/explore/v2.1/catalog/datasets";
    const INSEE_ANTONY = "92002";

    // IRIS code name map.
    const IRIS_LABELS = {
      "920020101": "Parc de Sceaux",
      "920020102": "Nouveau Cimetière",
      "920020103": "La Fontaine",
      "920020104": "U.S. Métro",
      "920020105": "Croix de Berny",
      "920020106": "Velpeau",
      "920020107": "Jean Moulin",
      "920020201": "11 Novembre",
      "920020202": "Guillebaud",
      "920020203": "Chemin de Fer",
      "920020204": "Bois de l'Aurore",
      "920020205": "Zone d'Activités",
      "920020301": "Pajeaud",
      "920020302": "Parvis du Breuil et de la Bièvre",
      "920020303": "Fontaine Michalon",
      "920020304": "Conservatoire Darius Milhaud",
      "920020305": "Grand l",
      "920020306": "Lionel Terray",
      "920020307": "Fontaine Mouton",
      "920020308": "Baconnets",
      "920020401": "Parc Heller",
      "920020402": "Céline",
      "920020403": "Hôtel de Ville",
      "920020404": "Clinique du Bois de Verrières",
      "920020405": "Ancien Cimetière",
      "920020406": "Bas Graviers",
      "920020407": "Les Godets",
    };

    // Metrics definitions for the toggle
    const METRICS = {
      total_inst: {
        label: "Nombre d'installations",
        unit: "",
      },
      pow_inst_kw: {
        label: "Puissance photovoltaïque raccordée au réseau",
        unit: "kW",
      },
      prod_1y_kwh: {
        label: "Production annuelle vers le réseau",
        unit: "kWh",
      },
    };

    // ------------
    // State
    // ------------

    let dataByYear = {};     // { 2020: [ {codeiris, total_inst, pow_inst_kw, prod_1y_kwh}, ...], ... }
    let years = [];          // [2020, 2021, ...]
    let irisList = [];       // distinct IRIS codes
    let chart = null;        // Chart.js instance

    // ------------
    // Utilities
    // ------------

    function registreDatasetId(year) {
      // Year -> "...-3112YY"
      const yy = String(year).slice(-2);
      return `registre-national-installation-production-stockage-electricite-agrege-3112${yy}`;
    }

    function irisDisplayName(codeiris) {
      if (codeiris === null || codeiris === undefined) {
        return "Quartier inconnu";
      }
      if (IRIS_LABELS[codeiris]) {
        return IRIS_LABELS[codeiris];
      }
      return `Secteur ${codeiris}`;
    }

    function setStatus(msg) {
      const el = document.getElementById("status");
      if (el) el.textContent = msg;
    }

    // ------------
    // Fetch helpers
    // ------------

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} for ${url}`);
      }
      return res.json();
    }

    async function datasetExists(datasetId) {
      // Cheap existence test: ask for 1 record
      const url = `${ODRE_BASE}/${datasetId}/records?limit=1`;
      const res = await fetch(url);
      if (res.status === 404) {
        return false;
      }
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} probing dataset ${datasetId}`);
      }
      return true;
    }

    async function findAvailableYears(firstYear = 2017, firstYearToTest = 2025, maxFutureYears = 2) {
      const currentYear = new Date().getFullYear();
      const years = [];

      for (let year = firstYear; year <= currentYear + maxFutureYears; year++) {
        if (year >= firstYearToTest) {
          const datasetId = registreDatasetId(year);
          const exists = await datasetExists(datasetId);
          if (!exists) break;
        }
        years.push(year);
      }

      if (years.length === 0) {
        throw new Error("No yearly registre datasets found");
      }
      return years;
    }

    async function fetchAntonyYearData(year) {
      const datasetId = registreDatasetId(year);
      const base = `${ODRE_BASE}/${datasetId}/records`;

      // Before 2020: "energieannuelleinjectee"
      // From 2020 onwards: "energieannuelleglissanteinjectee"
      const energyField =
        year < 2020
          ? "energieannuelleinjectee"
          : "energieannuelleglissanteinjectee";

      const params = new URLSearchParams({
        where: `codeinseecommune='${INSEE_ANTONY}' AND codefiliere like 'SOLAI' AND codetechnologie like 'PHOTV'`,
        select: [
          "codeiris as codeiris",
          "sum(nbinstallations) as total_inst",
          "sum(puismaxrac) as pow_inst_kw",
          `sum(${energyField}) as prod_1y_kwh`,
        ].join(", "),
        group_by: "codeiris",
        limit: "100",
      });

      const url = `${base}?${params.toString()}`;
      const json = await fetchJson(url);
      return json.results || [];
    }

    // ------------
    // Data preparation
    // ------------

    function computeIrisList() {
      const codes = new Set();
      for (const yr of years) {
        const rows = dataByYear[yr] || [];
        for (const row of rows) {
          // row.codeiris may be null
          const code = row.codeiris === null ? "NULL" : row.codeiris;
          codes.add(code);
        }
      }
      // Convert to array, but keep "NULL" (Sans IRIS) first, others sorted
      const arr = Array.from(codes);
      arr.sort((a, b) => {
        if (a === "NULL") return -1;
        if (b === "NULL") return 1;
        return a.localeCompare(b);
      });
      irisList = arr;
    }

    function getValue(row, metricKey) {
      const v = row[metricKey];
      if (v === null || v === undefined) return 0;
      // ODRE sometimes returns numbers as strings; make sure we parse
      return Number(v) || 0;
    }

    // ------------
    // Chart building
    // ------------

    function buildDatasets(metricKey, mode) {
      const metricDef = METRICS[metricKey];

      // Mode 1: total Antony (one bar per year)
      if (mode === "total") {
        const values = years.map((yr) => {
          const rows = dataByYear[yr] || [];
          return rows.reduce((sum, row) => sum + getValue(row, metricKey), 0);
        });

        return {
          datasets: [{
            label: "Total Antony",
            data: values,
            stack: "stack1",
            backgroundColor: undefined,
          }],
          metricLabel: metricDef.label,
          metricUnit: metricDef.unit,
        };
      }

      // Mode 2: by IRIS (stacked)
      const datasets = [];

      irisList.forEach((code) => {
        const isNull = (code === "NULL");
        const rawCode = isNull ? null : code;

        const values = years.map((yr) => {
          const rows = dataByYear[yr] || [];
          const row = rows.find(r => (r.codeiris === rawCode));
          if (!row) return 0;
          return getValue(row, metricKey);
        });

        datasets.push({
          label: irisDisplayName(rawCode),
          data: values,
          stack: "stack1",
          backgroundColor: undefined,
        });
      });

      return { datasets, metricLabel: metricDef.label, metricUnit: metricDef.unit };
    }

    function createOrUpdateChart(metricKey) {
      const ctx = document.getElementById("solarChart").getContext("2d");
      const modeSelect = document.getElementById("mode-select");
      const mode = modeSelect ? modeSelect.value : "iris";  // default

      const { datasets, metricLabel, metricUnit } = buildDatasets(metricKey, mode);
      const yLabel = metricUnit ? `${metricLabel} (${metricUnit})` : metricLabel;
      const stacked = (mode === "iris");

      if (chart) {
        chart.data.labels = years;
        chart.data.datasets = datasets;
        chart.options.plugins.title.text = metricLabel;
        chart.options.scales.y.title.text = yLabel;
        chart.options.scales.x.stacked = stacked;
        chart.options.scales.y.stacked = stacked;
        chart.update();
        return;
      }

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: years,
          datasets: datasets,
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: metricLabel,
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.dataset.label || "";
                  const value = context.parsed.y;
                  return `${label}: ${value.toLocaleString("fr-FR")}`;
                },
              },
            },
          },
          scales: {
            x: {
              stacked: stacked,
            },
            y: {
              stacked: stacked,
              beginAtZero: true,
              title: {
                display: true,
                text: yLabel,
              },
            },
          },
        },
      });
    }

    // ------------
    // Main init
    // ------------

    async function init() {
      try {
        setStatus("Recherche des années disponibles…");
        years = await findAvailableYears();
        setStatus(`Années disponibles : ${years.join(", ")}. Chargement des données d'Antony…`);

        // Fetch Antony data for each year
        for (const year of years) {
          const rows = await fetchAntonyYearData(year);
          dataByYear[year] = rows;
        }

        computeIrisList();
        setStatus("Données chargées. Vous pouvez changer la métrique avec le menu déroulant.");

        const metricSelect = document.getElementById("metric-select");
        const modeSelect = document.getElementById("mode-select");

        const initialMetric = metricSelect.value;
        createOrUpdateChart(initialMetric);

        metricSelect.addEventListener("change", () => {
          createOrUpdateChart(metricSelect.value);
        });

        modeSelect.addEventListener("change", () => {
          createOrUpdateChart(metricSelect.value);
        });

      } catch (err) {
        console.error(err);
        setStatus("Erreur lors du chargement des données : " + err.message);
      }
    }

    // Run on page load
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
